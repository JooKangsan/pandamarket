#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” commit ì´ì „ì— prettier, lint ê·œì¹™ì„ ì ìš©í•©ë‹ˆë‹¤..."

# YARN_ENABLE_IMMUTABLE_INSTALLS í™˜ê²½ë³€ìˆ˜ ì„¤ì •
export YARN_ENABLE_IMMUTABLE_INSTALLS=false

# lint-staged ì‹¤í–‰
yarn lint-staged
if [ $? -ne 0 ]; then
    echo "âŒ lint-staged ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
    exit 1
fi

# PnP í™˜ê²½ì—ì„œ git ëª…ë ¹ì–´ ì‹¤í–‰
changed_files=$(git diff --name-only --staged --diff-filter=d)
if [ $? -ne 0 ]; then
    echo "âŒ ë³€ê²½ëœ íŒŒì¼ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
    exit 1
fi

# íŒŒì¼ ì¬ìŠ¤í…Œì´ì§• (ê²½ë¡œ ê²€ì‚¬ ì¶”ê°€)
for file in $changed_files; do
    if [ -f "$file" ]; then
        # ìƒëŒ€ ê²½ë¡œ ì²˜ë¦¬ë¥¼ ìœ„í•œ í”„ë¡œì íŠ¸ ë£¨íŠ¸ ê²½ë¡œ ì‚¬ìš©
        git add "$(git rev-parse --show-toplevel)/$file"
    fi
done

# Yarn Berry ìºì‹œ ì •ë¦¬ (ì„ íƒì )
yarn cache clean

echo "âœ… ëª¨ë“  prettier, lint ê·œì¹™ì´ ì„±ê³µì ìœ¼ë¡œ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤."